<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERP Support & Request System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<style>
    body {
        font-family: 'Inter', sans-serif;
    }
    .poppins {
        font-family: 'Poppins', sans-serif;
    }
    .loader {
        border: 3px solid #f3f3f3;
        border-radius: 50%;
        border-top: 3px solid #3498db;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        display: none;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .notification {
        transform: translateY(-100%);
        transition: transform 0.3s ease-in-out;
    }
    .notification.show {
        transform: translateY(0);
    }
    .chart-container {
        height: 200px;
        position: relative;
    }
    .chart-bar {
        position: absolute;
        bottom: 0;
        width: 30px;
        border-radius: 4px 4px 0 0;
        transition: height 0.5s ease;
    }
</style>
<body class="bg-gray-50">
    <div id="notification" class="notification fixed top-0 left-0 right-0 bg-green-500 text-white p-4 text-center z-50"></div>

    <!-- Navigation -->
    <nav class="bg-blue-600 text-white p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="bi bi-headset text-2xl"></i>
                <h1 class="text-xl font-bold poppins">ERP Support System</h1>
            </div>
            <div class="flex items-center gap-4">
                <span id="userName" class="text-sm hidden md:inline-block">John Doe</span>
                <span id="userDepartment" class="text-sm hidden md:inline-block">IT Department</span>
                <span id="userRole" class="text-sm bg-blue-800 px-2 py-1 rounded">Role: User</span>
                <div class="relative group">
                    <button class="bg-blue-500 px-3 py-1 rounded hover:bg-blue-400 flex items-center gap-1">
                        <i class="bi bi-gear"></i>
                        <span class="hidden md:inline-block">Options</span>
                    </button>
                    <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg hidden group-hover:block z-10">
                        <button onclick="changeRole()" class="text-gray-700 w-full text-left px-4 py-2 hover:bg-gray-100">Switch Role</button>
                        <button onclick="showAuditLogs()" class="text-gray-700 w-full text-left px-4 py-2 hover:bg-gray-100">View Audit Logs</button>
                        <button onclick="clearNotifications()" class="text-gray-700 w-full text-left px-4 py-2 hover:bg-gray-100">Clear Notifications</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Notification Center -->
    <div id="notificationCenter" class="fixed bottom-4 right-4 z-50">
        <div id="notificationList" class="hidden bg-white rounded-lg shadow-xl p-4 w-80 max-h-96 overflow-y-auto mb-2">
            <h3 class="font-bold text-lg mb-2 border-b pb-2 flex justify-between items-center">
                <span>Notifications</span>
                <button onclick="toggleNotifications()" class="text-gray-500 hover:text-gray-700">
                    <i class="bi bi-x-lg"></i>
                </button>
            </h3>
            <div id="notificationItems" class="space-y-2">
                <!-- Notifications will be added here -->
            </div>
        </div>
        <button onclick="toggleNotifications()" class="bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 relative">
            <i class="bi bi-bell-fill"></i>
            <span id="notificationCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span>
        </button>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto p-4">
        <!-- Role-based view selector -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex flex-wrap -mx-2">
                <div class="px-2 w-full sm:w-1/2 md:w-1/4 mb-4 md:mb-0">
                    <div id="userViewBtn" onclick="changeView('user')" class="cursor-pointer p-3 border rounded-lg transition-all flex items-center gap-3 bg-blue-50 border-blue-200">
                        <i class="bi bi-person-fill text-2xl text-blue-600"></i>
                        <span class="font-medium">User View</span>
                    </div>
                </div>
                <div class="px-2 w-full sm:w-1/2 md:w-1/4 mb-4 md:mb-0">
                    <div id="hodViewBtn" onclick="changeView('hod')" class="cursor-pointer p-3 border rounded-lg transition-all flex items-center gap-3">
                        <i class="bi bi-briefcase-fill text-2xl text-gray-600"></i>
                        <span class="font-medium">HOD View</span>
                    </div>
                </div>
                <div class="px-2 w-full sm:w-1/2 md:w-1/4 mb-4 sm:mb-0">
                    <div id="itHeadViewBtn" onclick="changeView('it_head')" class="cursor-pointer p-3 border rounded-lg transition-all flex items-center gap-3">
                        <i class="bi bi-pc-display text-2xl text-gray-600"></i>
                        <span class="font-medium">IT Head View</span>
                    </div>
                </div>
                <div class="px-2 w-full sm:w-1/2 md:w-1/4">
                    <div id="technicianViewBtn" onclick="changeView('technician')" class="cursor-pointer p-3 border rounded-lg transition-all flex items-center gap-3">
                        <i class="bi bi-tools text-2xl text-gray-600"></i>
                        <span class="font-medium">Technician View</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Role-based Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center justify-between">
                    <h3 class="font-semibold text-gray-700">Total Requests</h3>
                    <i class="bi bi-ticket-detailed text-blue-600 text-xl"></i>
                </div>
                <p class="text-2xl font-bold text-blue-600 mt-2" id="totalRequests">0</p>
                <div class="mt-2 text-xs text-gray-500">
                    <span id="totalRequestsChange" class="font-medium">+0%</span> from last week
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center justify-between">
                    <h3 class="font-semibold text-gray-700">Pending</h3>
                    <i class="bi bi-hourglass-split text-yellow-600 text-xl"></i>
                </div>
                <p class="text-2xl font-bold text-yellow-600 mt-2" id="pendingRequests">0</p>
                <div class="mt-2 text-xs text-gray-500">
                    <span id="pendingRequestsChange" class="font-medium">+0%</span> from last week
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center justify-between">
                    <h3 class="font-semibold text-gray-700">Resolved</h3>
                    <i class="bi bi-check-circle text-green-600 text-xl"></i>
                </div>
                <p class="text-2xl font-bold text-green-600 mt-2" id="resolvedRequests">0</p>
                <div class="mt-2 text-xs text-gray-500">
                    <span id="resolvedRequestsChange" class="font-medium">+0%</span> from last week
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <div class="flex items-center justify-between">
                    <h3 class="font-semibold text-gray-700">Avg Resolution Time</h3>
                    <i class="bi bi-stopwatch text-purple-600 text-xl"></i>
                </div>
                <p class="text-2xl font-bold text-purple-600 mt-2" id="avgResolutionTime">0h</p>
                <div class="mt-2 text-xs text-gray-500">
                    <span id="avgResolutionTimeChange" class="font-medium">+0%</span> from last week
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-8">
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="font-semibold text-gray-700 mb-4">Request Types Distribution</h3>
                <div class="chart-container flex items-end justify-around">
                    <div class="text-center">
                        <div id="incidentBar" class="chart-bar bg-blue-500 mx-auto" style="height: 0;"></div>
                        <p class="mt-2 text-sm">Incidents</p>
                    </div>
                    <div class="text-center">
                        <div id="serviceBar" class="chart-bar bg-green-500 mx-auto" style="height: 0;"></div>
                        <p class="mt-2 text-sm">Services</p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="font-semibold text-gray-700 mb-4">Category Distribution</h3>
                <div class="chart-container flex items-end justify-around">
                    <div class="text-center">
                        <div id="applicationBar" class="chart-bar bg-purple-500 mx-auto" style="height: 0;"></div>
                        <p class="mt-2 text-sm">Application</p>
                    </div>
                    <div class="text-center">
                        <div id="hardwareBar" class="chart-bar bg-yellow-500 mx-auto" style="height: 0;"></div>
                        <p class="mt-2 text-sm">Hardware</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- HOD Approval Queue - Only visible for HOD role -->
        <div id="hodApprovalQueue" class="bg-white p-6 rounded-lg shadow mb-8 hidden">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-list-check text-blue-600"></i>
                Service Request Approval Queue
            </h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="hodApprovalTable" class="bg-white divide-y divide-gray-200">
                        <!-- HOD approval queue will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- IT Head Assignment Queue - Only visible for IT Head role -->
        <div id="itHeadQueue" class="bg-white p-6 rounded-lg shadow mb-8 hidden">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-person-check text-blue-600"></i>
                Requests Pending Assignment
            </h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="itHeadQueueTable" class="bg-white divide-y divide-gray-200">
                        <!-- IT Head queue will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Technician Task List - Only visible for Technician role -->
        <div id="technicianTasks" class="bg-white p-6 rounded-lg shadow mb-8 hidden">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-list-task text-blue-600"></i>
                My Assigned Tasks
            </h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Info</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="technicianTaskTable" class="bg-white divide-y divide-gray-200">
                        <!-- Technician tasks will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Request Form - Visible for all but primarily for users -->
        <div id="requestForm" class="bg-white p-6 rounded-lg shadow mb-8">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                <i class="bi bi-file-earmark-plus text-blue-600"></i>
                Submit Support Request
            </h2>
            <form onsubmit="submitRequest(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">User Name</label>
                    <input type="text" id="formUserName" readonly value="John Doe" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 bg-gray-100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Department</label>
                    <input type="text" id="formDepartment" readonly value="IT Department" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 bg-gray-100">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Desktop Name</label>
                    <input type="text" id="desktopName" required placeholder="e.g., DESKTOP-ABC123" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">IP Address</label>
                    <input type="text" id="ipAddress" required pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$" placeholder="e.g., 192.168.1.100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Request Type</label>
                    <select id="requestType" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Select a request type</option>
                        <option value="incident">Incident - Report an issue or problem</option>
                        <option value="service">Service Request - Request a new service</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Note: Service requests require HOD approval before processing.</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Category</label>
                    <select id="category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="">Select a category</option>
                        <option value="application">Application - Software related</option>
                        <option value="hardware">Hardware - Physical equipment related</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Priority</label>
                    <select id="priority" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        <option value="low">Low - Not time-sensitive</option>
                        <option value="medium" selected>Medium - Normal processing</option>
                        <option value="high">High - Urgent attention needed</option>
                        <option value="critical">Critical - Business operations affected</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Attachment</label>
                    <input type="file" id="attachment" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <p class="text-xs text-gray-500 mt-1">Optional: Upload screenshot (max 5MB)</p>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700">Query Description</label>
                    <textarea id="description" required rows="4" placeholder="Please provide detailed information about your request..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                </div>
                <div class="md:col-span-2">
                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center">
                        <i class="bi bi-send mr-2"></i>
                        <span>Submit Request</span>
                        <div id="submitLoader" class="loader ml-2"></div>
                    </button>
                </div>
            </form>
        </div>

        <!-- Requests Table -->
        <div class="bg-white p-6 rounded-lg shadow">
            <div class="flex flex-wrap justify-between items-center mb-4">
                <h2 class="text-xl font-bold mb-2 md:mb-0 flex items-center gap-2">
                    <i class="bi bi-list-ul text-blue-600"></i>
                    Request History
                </h2>
                <div class="flex flex-wrap gap-2">
                    <select id="typeFilter" onchange="filterRequests()" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                        <option value="all">All Types</option>
                        <option value="incident">Incident</option>
                        <option value="service">Service</option>
                    </select>
                    <select id="categoryFilter" onchange="filterRequests()" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                        <option value="all">All Categories</option>
                        <option value="application">Application</option>
                        <option value="hardware">Hardware</option>
                    </select>
                    <select id="statusFilter" onchange="filterRequests()" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                        <option value="all">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="approved">Approved</option>
                        <option value="assigned">Assigned</option>
                        <option value="resolved">Resolved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                    <input type="date" id="dateFilter" onchange="filterRequests()" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                    <button onclick="clearFilters()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 rounded text-sm">
                        <i class="bi bi-x-circle"></i> Clear
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTable" class="bg-white divide-y divide-gray-200">
                        <!-- Requests will be populated here -->
                    </tbody>
                </table>
                <!-- Empty state -->
                <div id="emptyState" class="hidden text-center py-10">
                    <i class="bi bi-inbox text-gray-400 text-4xl"></i>
                    <p class="mt-2 text-gray-500">No requests found matching your filters</p>
                    <button onclick="clearFilters()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                        Clear Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg p-8 max-w-md w-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="modalTitle" class="text-lg font-bold"></h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div id="modalContent"></div>
                <div id="modalFooter" class="mt-6 flex justify-end gap-2">
                    <button onclick="closeModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Close</button>
                    <button id="modalAction" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Action</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Log Modal -->
    <div id="auditLogModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg p-8 max-w-2xl w-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Audit Logs</h3>
                    <button onclick="closeAuditLogModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div class="overflow-y-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogTable" class="bg-white divide-y divide-gray-200">
                            <!-- Audit logs will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="closeAuditLogModal()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Close</button>
                </div>
            </div>
        </div>
    </div>

<script>
// Global variables
let currentRole = 'user';
let currentView = 'user';
let requests = [];
let auditLogs = [];
let notifications = [];
const appSlug = 'support-system-123456';
const departments = ['IT', 'HR', 'Finance', 'Marketing', 'Operations'];
const technicians = [
    { id: 'tech1', name: 'Alex Johnson', specialization: 'Network' },
    { id: 'tech2', name: 'Sarah Chen', specialization: 'Hardware' },
    { id: 'tech3', name: 'Miguel Rodriguez', specialization: 'Software' },
    { id: 'tech4', name: 'Priya Patel', specialization: 'Database' }
];

// Initialize app
async function initializeApp() {
    // First, check and create collections if needed
    await initializeCollections();
    
    // Load requests
    await loadRequests();
    
    // Load audit logs
    await loadAuditLogs();
    
    // Initialize notifications
    initializeNotifications();
    
    // Set up UI based on role
    setupUI();
    
    // Update metrics
    updateDashboard();
    
    // Update charts
    updateCharts();
}

// Initialize MongoDB collections
async function initializeCollections() {
    try {
        // First check if collections exist by trying to read from them
        const collectionsToCheck = ['requests', 'auditLogs', 'notifications'];
        
        for (const collection of collectionsToCheck) {
            await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer 9qVU9vgW1AdSZJL4WNZ2fzKtFC72',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    appSlug,
                    action: 'read',
                    collection
                })
            });
        }
    } catch (error) {
        console.error('Error initializing collections:', error);
    }
}

// Load requests from database
async function loadRequests() {
    try {
        const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer 9qVU9vgW1AdSZJL4WNZ2fzKtFC72',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                appSlug,
                action: 'read',
                collection: 'requests'
            })
        });
        const data = await response.json();
        if (data.success) {
            requests = data.result || [];
            renderRequests();
            renderRoleSpecificViews();
        }
    } catch (error) {
        console.error('Error loading requests:', error);
        showNotification('Error loading requests', 'error');
    }
}

// Load audit logs
async function loadAuditLogs() {
    try {
        const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer 9qVU9vgW1AdSZJL4WNZ2fzKtFC72',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                appSlug,
                action: 'read',
                collection: 'auditLogs'
            })
        });
        const data = await response.json();
        if (data.success) {
            auditLogs = data.result || [];
        }
    } catch (error) {
        console.error('Error loading audit logs:', error);
    }
}

// Load notifications
async function initializeNotifications() {
    try {
        const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer 9qVU9vgW1AdSZJL4WNZ2fzKtFC72',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                appSlug,
                action: 'read',
                collection: 'notifications',
                conditions: { role: currentRole }
            })
        });
        const data = await response.json();
        if (data.success) {
            notifications = data.result || [];
            updateNotificationBadge();
            renderNotifications();
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

// Set up UI based on role
function setupUI() {
    document.getElementById('userName').textContent = 'John Doe';
    document.getElementById('formUserName').value = 'John Doe';
    
    // Random department for demo
    const department = departments[Math.floor(Math.random() * departments.length)];
    document.getElementById('userDepartment').textContent = department + ' Department';
    document.getElementById('formDepartment').value = department + ' Department';
    
    // Set up role-specific UI
    document.getElementById('userRole').textContent = `Role: ${formatRole(currentRole)}`;
    
    // Change view to match current role
    changeView(currentRole);
}

// Submit new request
async function submitRequest(event) {
    event.preventDefault();
    document.getElementById('submitLoader').style.display = 'block';
    
    const requestData = {
        userName: document.getElementById('formUserName').value,
        department: document.getElementById('formDepartment').value,
        desktopName: document.getElementById('desktopName').value,
        ipAddress: document.getElementById('ipAddress').value,
        requestType: document.getElementById('requestType').value,
        category: document.getElementById('category').value,
        priority: document.getElementById('priority').value,
        description: document.getElementById('description').value,
        status: document.getElementById('requestType').value === 'incident' ? 'pending' : 'pending_approval',
        date: new Date().toISOString(),
        comments: [],
        createdBy: currentRole,
        assignedTo: null,
        attachmentUrl: null
    };

    try {
        const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer 9qVU9vgW1AdSZJL4WNZ2fzKtFC72',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                appSlug,
                action: 'create',
                collection: 'requests',
                data: requestData
            })
        });
        const data = await response.json();
        
        if (data.success) {
            // Add audit log
            await addAuditLog({
                user: requestData.userName,
                action: 'Created Request',
                details: `${requestData.requestType} request for ${requestData.category}`
            });
            
            // Create notifications
            if (requestData.requestType === 'incident') {
                await addNotification({
                    role: 'it_head',
                    title: 'New Incident',
                    message: `${requestData.userName} reported a new incident`,
                    requestId: data.result.insertedId,
                    date: new Date().toISOString()
                });
            } else {
                await addNotification({
                    role: 'hod',
                    title: 'Service Request Approval',
                    message: `${requestData.userName} requested service approval`,
                    requestId: data.result.insertedId,
                    date: new Date().toISOString()
                });
            }
            
            showNotification('Request submitted successfully!');
            event.target.reset();
            await loadRequests();
            updateDashboard();
            updateCharts();
        }
    } catch (error) {
        console.error('Error submitting request:', error);
        showNotification('Error submitting request', 'error');
    } finally {
        document.getElementById('submitLoader').style.display = 'none';
    }
}

// Add audit log
async function addAuditLog(logData) {
    try {
        const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer 9qVU9vgW1AdSZJL4WNZ2fzKtFC72',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                appSlug,
                action: 'create',
                collection: 'auditLogs',
                data: {
                    ...logData,
                    timestamp: new Date().toISOString()
                }
            })
        });
        
        const data = await response.json();
        if (data.success) {
            auditLogs.push({
                ...logData,
                timestamp: new Date().toISOString(),
                _id: data.result.insertedId
            });
        }
    } catch (error) {
        console.error('Error adding audit log:', error);
    }
}

// Add notification
async function addNotification(notificationData) {
    try {
        const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer 9qVU9vgW1AdSZJL4WNZ2fzKtFC72',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                appSlug,
                action: 'create',
                collection: 'notifications',
                data: {
                    ...notificationData,
                    isRead: false
                }
            })
        });
        
        return response.json();
    } catch (error) {
        console.error('Error adding notification:', error);
    }
}

// Mark notification as read
async function markNotificationAsRead(id) {
    try {
        const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer 9qVU9vgW1AdSZJL4WNZ2fzKtFC72',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                appSlug,
                action: 'update',
                collection: 'notifications',
                conditions: { _id: id },
                data: { isRead: true }
            })
        });
        
        const data = await response.json();
        if (data.success) {
            notifications = notifications.map(n => 
                n._id === id ? {...n, isRead: true} : n
            );
            updateNotificationBadge();
            renderNotifications();
        }
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
}

// Clear all notifications
async function clearNotifications() {
    try {
        const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer 9qVU9vgW1AdSZJL4WNZ2fzKtFC72',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                appSlug,
                action: 'update',
                collection: 'notifications',
                conditions: { role: currentRole },
                data: { isRead: true }
            })
        });
        
        const data = await response.json();
        if (data.success) {
            notifications = notifications.map(n => ({...n, isRead: true}));
            updateNotificationBadge();
            renderNotifications();
            showNotification('Notifications cleared');
        }
    } catch (error) {
        console.error('Error clearing notifications:', error);
    }
}

// Update request status
async function updateRequestStatus(id, status, comment = '', assignedTo = null) {
    try {
        const updateData = { status };
        
        // Add comment if provided
        if (comment) {
            updateData.$push = { 
                comments: { 
                    text: comment, 
                    user: document.getElementById('userName').textContent,
                    role: currentRole,
                    date: new Date().toISOString() 
                } 
            };
        }
        
        // Add assignee if provided
        if (assignedTo) {
            updateData.assignedTo = assignedTo;
        }
        
        const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer 9qVU9vgW1AdSZJL4WNZ2fzKtFC72',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                appSlug,
                action: 'update',
                collection: 'requests',
                conditions: { _id: id },
                data: updateData
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Get the request that was updated
            const request = requests.find(r => r._id === id);
            
            // Track the action in audit log
            await addAuditLog({
                user: document.getElementById('userName').textContent,
                action: `Changed Status to ${status}`,
                details: `Request ${id.slice(-6)}: ${comment}`
            });
            
            // Create appropriate notifications
            if (status === 'approved') {
                await addNotification({
                    role: 'it_head',
                    title: 'Request Approved',
                    message: `A service request has been approved by HOD`,
                    requestId: id,
                    date: new Date().toISOString()
                });
                
                await addNotification({
                    role: 'user',
                    title: 'Request Approved',
                    message: `Your service request has been approved`,
                    requestId: id,
                    date: new Date().toISOString()
                });
            } else if (status === 'rejected') {
                await addNotification({
                    role: 'user',
                    title: 'Request Rejected',
                    message: `Your service request was rejected: ${comment}`,
                    requestId: id,
                    date: new Date().toISOString()
                });
            } else if (status === 'assigned') {
                await addNotification({
                    role: 'technician',
                    title: 'New Task Assigned',
                    message: `You have been assigned a new request`,
                    requestId: id,
                    date: new Date().toISOString()
                });
                
                await addNotification({
                    role: 'user',
                    title: 'Request Assigned',
                    message: `Your request has been assigned to a technician`,
                    requestId: id,
                    date: new Date().toISOString()
                });
            } else if (status === 'resolved') {
                await addNotification({
                    role: 'user',
                    title: 'Request Resolved',
                    message: `Your request has been resolved: ${comment}`,
                    requestId: id,
                    date: new Date().toISOString()
                });
                
                await addNotification({
                    role: 'it_head',
                    title: 'Request Resolved',
                    message: `A request has been resolved by a technician`,
                    requestId: id,
                    date: new Date().toISOString()
                });
            }
            
            showNotification('Request updated successfully!');
            await loadRequests();
            await initializeNotifications();
            updateDashboard();
            updateCharts();
        }
    } catch (error) {
        console.error('Error updating request:', error);
        showNotification('Error updating request', 'error');
    }
}

// Render requests table
function renderRequests() {
    const table = document.getElementById('requestsTable');
    const emptyState = document.getElementById('emptyState');
    
    // Apply filters
    const typeFilter = document.getElementById('typeFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    
    let filteredRequests = [...requests];
    
    if (typeFilter !== 'all') {
        filteredRequests = filteredRequests.filter(r => r.requestType === typeFilter);
    }
    
    if (categoryFilter !== 'all') {
        filteredRequests = filteredRequests.filter(r => r.category === categoryFilter);
    }
    
    if (statusFilter !== 'all') {
        filteredRequests = filteredRequests.filter(r => r.status === statusFilter);
    }
    
    if (dateFilter) {
        const filterDate = new Date(dateFilter).toDateString();
        filteredRequests = filteredRequests.filter(r => new Date(r.date).toDateString() === filterDate);
    }
    
    // Role-based filtering (if user is not admin/IT Head)
    if (currentRole === 'user') {
        filteredRequests = filteredRequests.filter(r => r.userName === document.getElementById('userName').textContent);
    } else if (currentRole === 'technician') {
        filteredRequests = filteredRequests.filter(r => r.assignedTo === 'tech1'); // For demo purposes
    }
    
    // Sort by most recent first
    filteredRequests.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (filteredRequests.length === 0) {
        table.innerHTML = '';
        emptyState.classList.remove('hidden');
    } else {
        emptyState.classList.add('hidden');
        
        table.innerHTML = filteredRequests.map(request => `
            <tr class="hover:bg-gray-50">
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${request._id.slice(-6)}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">${request.requestType}</td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">${request.category}</td>
                <td class="px-3 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                        ${getStatusColor(request.status)}"
                    >
                        ${formatStatus(request.status)}
                    </span>
                </td>
                <td class="px-3 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                        ${getPriorityColor(request.priority)}"
                    >
                        ${request.priority}
                    </span>
                </td>
                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${formatDate(request.date)}
                </td>
                <td class="px-3 py-4 whitespace-nowrap text-sm font-medium flex">
                    <button onclick="viewRequest('${request._id}')" 
                        class="text-blue-600 hover:text-blue-900 mr-2" 
                        title="View details">
                        <i class="bi bi-eye"></i>
                    </button>
                    ${getActionButtons(request)}
                </td>
            </tr>
        `).join('');
    }
}

// Render role-specific views
function renderRoleSpecificViews() {
    if (currentRole === 'hod') {
        renderHodQueue();
    } else if (currentRole === 'it_head') {
        renderItHeadQueue();
    } else if (currentRole === 'technician') {
        renderTechnicianTasks();
    }
}

// Render HOD approval queue
function renderHodQueue() {
    const hodTable = document.getElementById('hodApprovalTable');
    const pendingApprovalRequests = requests.filter(r => r.status === 'pending_approval' && r.requestType === 'service');
    
    if (pendingApprovalRequests.length === 0) {
        hodTable.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-10 text-center text-sm text-gray-500">
                    <p>No pending service requests for approval</p>
                </td>
            </tr>
        `;
    } else {
        hodTable.innerHTML = pendingApprovalRequests.map(request => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${request._id.slice(-6)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${request.userName}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">${request.category}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${formatDate(request.date)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="viewRequest('${request._id}')" 
                        class="text-blue-600 hover:text-blue-900 mr-2">
                        View
                    </button>
                    <button onclick="approveRequest('${request._id}')" 
                        class="text-green-600 hover:text-green-900 mr-2">
                        Approve
                    </button>
                    <button onclick="rejectRequest('${request._id}')" 
                        class="text-red-600 hover:text-red-900">
                        Reject
                    </button>
                </td>
            </tr>
        `).join('');
    }
}

// Render IT Head queue
function renderItHeadQueue() {
    const itHeadTable = document.getElementById('itHeadQueueTable');
    // For IT Head, show all pending incidents and approved service requests
    const pendingRequests = requests.filter(r => 
        (r.status === 'pending' && r.requestType === 'incident') || 
        (r.status === 'approved' && r.requestType === 'service')
    );
    
    if (pendingRequests.length === 0) {
        itHeadTable.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-10 text-center text-sm text-gray-500">
                    <p>No pending requests for assignment</p>
                </td>
            </tr>
        `;
    } else {
        itHeadTable.innerHTML = pendingRequests.map(request => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${request._id.slice(-6)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">${request.requestType}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">${request.category}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${formatDate(request.date)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="viewRequest('${request._id}')" 
                        class="text-blue-600 hover:text-blue-900 mr-2">
                        View
                    </button>
                    <button onclick="assignRequest('${request._id}')" 
                        class="text-blue-600 hover:text-blue-900">
                        Assign
                    </button>
                </td>
            </tr>
        `).join('');
    }
}

// Render Technician tasks
function renderTechnicianTasks() {
    const techTable = document.getElementById('technicianTaskTable');
    // For technician, show only assigned tasks
    const assignedTasks = requests.filter(r => r.status === 'assigned' && r.assignedTo === 'tech1'); // For demo
    
    if (assignedTasks.length === 0) {
        techTable.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-10 text-center text-sm text-gray-500">
                    <p>No tasks currently assigned to you</p>
                </td>
            </tr>
        `;
    } else {
        techTable.innerHTML = assignedTasks.map(request => `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${request._id.slice(-6)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">${request.requestType}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${request.userName}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${request.desktopName} - ${request.ipAddress}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="viewRequest('${request._id}')" 
                        class="text-blue-600 hover:text-blue-900 mr-2">
                        View
                    </button>
                    <button onclick="resolveRequest('${request._id}')" 
                        class="text-green-600 hover:text-green-900">
                        Resolve
                    </button>
                </td>
            </tr>
        `).join('');
    }
}

// Render audit logs
function renderAuditLogs() {
    const auditTable = document.getElementById('auditLogTable');
    
    if (auditLogs.length === 0) {
        auditTable.innerHTML = `
            <tr>
                <td colspan="4" class="px-6 py-10 text-center text-sm text-gray-500">
                    <p>No audit logs found</p>
                </td>
            </tr>
        `;
    } else {
        // Sort by most recent first
        const sortedLogs = [...auditLogs].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        auditTable.innerHTML = sortedLogs.map(log => `
            <tr class="hover:bg-gray-50">
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">
                    ${formatDate(log.timestamp)}
                </td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">${log.user}</td>
                <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">${log.action}</td>
                <td class="px-3 py-3 text-sm text-gray-500">${log.details}</td>
            </tr>
        `).join('');
    }
}

// Render notifications
function renderNotifications() {
    const notificationItems = document.getElementById('notificationItems');
    
    if (notifications.length === 0) {
        notificationItems.innerHTML = `
            <p class="text-center text-gray-500 py-4">No notifications</p>
        `;
    } else {
        // Filter for current role and sort by most recent
        const roleNotifications = [...notifications]
            .filter(n => n.role === currentRole)
            .sort((a, b) => new Date(b.date) - new Date(a.date));
        
        notificationItems.innerHTML = roleNotifications.map(notification => `
            <div class="p-3 rounded-lg ${notification.isRead ? 'bg-gray-50' : 'bg-blue-50'} border ${notification.isRead ? 'border-gray-200' : 'border-blue-200'}">
                <div class="flex justify-between items-start">
                    <h4 class="font-semibold ${notification.isRead ? 'text-gray-700' : 'text-blue-700'}">
                        ${notification.title}
                    </h4>
                    <div class="flex items-center">
                        <span class="text-xs text-gray-500">${formatTimeAgo(notification.date)}</span>
                        ${!notification.isRead ? `
                            <button onclick="markNotificationAsRead('${notification._id}')" class="ml-2 text-gray-400 hover:text-gray-600" title="Mark as read">
                                <i class="bi bi-check-circle"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
                <p class="text-sm mt-1">${notification.message}</p>
                <div class="mt-2">
                    <button 
                        onclick="viewNotificationRequest('${notification.requestId}')" 
                        class="text-xs text-blue-600 hover:text-blue-800">
                        View Request
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    updateNotificationBadge();
}

// Update notification badge count
function updateNotificationBadge() {
    const unreadCount = notifications.filter(n => !n.isRead && n.role === currentRole).length;
    document.getElementById('notificationCount').textContent = unreadCount;
    
    if (unreadCount === 0) {
        document.getElementById('notificationCount').classList.add('hidden');
    } else {
        document.getElementById('notificationCount').classList.remove('hidden');
    }
}

// View request from notification
function viewNotificationRequest(id) {
    viewRequest(id);
    toggleNotifications();
}

// Toggle notification panel
function toggleNotifications() {
    const notificationList = document.getElementById('notificationList');
    notificationList.classList.toggle('hidden');
    renderNotifications();
}

// Get action buttons based on role and status
function getActionButtons(request) {
    if (currentRole === 'hod' && request.status === 'pending_approval' && request.requestType === 'service') {
        return `
            <button onclick="approveRequest('${request._id}')" 
                class="text-green-600 hover:text-green-900 mr-2" 
                title="Approve request">
                <i class="bi bi-check-circle"></i>
            </button>
            <button onclick="rejectRequest('${request._id}')" 
                class="text-red-600 hover:text-red-900" 
                title="Reject request">
                <i class="bi bi-x-circle"></i>
            </button>
        `;
    }
    
    if (currentRole === 'it_head') {
        // For IT Head, can assign pending incidents and approved service requests
        if ((request.status === 'pending' && request.requestType === 'incident') || 
            (request.status === 'approved' && request.requestType === 'service')) {
            return `
                <button onclick="assignRequest('${request._id}')" 
                    class="text-blue-600 hover:text-blue-900" 
                    title="Assign request">
                    <i class="bi bi-person-plus"></i>
                </button>
            `;
        }
    }
    
    if (currentRole === 'technician' && request.status === 'assigned' && request.assignedTo === 'tech1') {
        return `
            <button onclick="resolveRequest('${request._id}')" 
                class="text-green-600 hover:text-green-900" 
                title="Mark as resolved">
                <i class="bi bi-check-circle"></i>
            </button>
        `;
    }
    
    if (currentRole === 'user' && request.status === 'resolved') {
        return `
            <button onclick="addFeedback('${request._id}')" 
                class="text-purple-600 hover:text-purple-900" 
                title="Add feedback">
                <i class="bi bi-chat-dots"></i>
            </button>
        `;
    }
    
    return '';
}

// View request details
function viewRequest(id) {
    const request = requests.find(r => r._id === id);
    if (!request) return;

    document.getElementById('modalTitle').textContent = `Request ${id.slice(-6)} - ${formatStatus(request.status)}`;
    
    document.getElementById('modalContent').innerHTML = `
        <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h4 class="text-sm font-medium text-gray-500">Type</h4>
                    <p class="mt-1 capitalize">${request.requestType}</p>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-500">Category</h4>
                    <p class="mt-1 capitalize">${request.category}</p>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-500">User</h4>
                    <p class="mt-1">${request.userName}</p>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-500">Department</h4>
                    <p class="mt-1">${request.department || 'N/A'}</p>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-500">System Info</h4>
                    <p class="mt-1">${request.desktopName} - ${request.ipAddress}</p>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-500">Priority</h4>
                    <p class="mt-1 capitalize">${request.priority || 'Medium'}</p>
                </div>
                ${request.assignedTo ? `
                <div>
                    <h4 class="text-sm font-medium text-gray-500">Assigned To</h4>
                    <p class="mt-1">${getTechnicianName(request.assignedTo)}</p>
                </div>
                ` : ''}
                <div>
                    <h4 class="text-sm font-medium text-gray-500">Date Submitted</h4>
                    <p class="mt-1">${formatDate(request.date)}</p>
                </div>
            </div>
            
            <div>
                <h4 class="text-sm font-medium text-gray-500">Description</h4>
                <p class="mt-1 p-2 bg-gray-50 rounded">${request.description}</p>
            </div>
            
            <div>
                <h4 class="text-sm font-medium text-gray-500">Comments</h4>
                <div class="mt-2 space-y-2 max-h-48 overflow-y-auto">
                    ${request.comments && request.comments.length > 0 ? 
                        request.comments.map(comment => `
                            <div class="bg-gray-50 p-3 rounded border-l-4 border-blue-500">
                                <div class="flex justify-between">
                                    <p class="text-sm font-medium">${comment.user || 'User'} <span class="text-xs text-gray-500">(${formatRole(comment.role)})</span></p>
                                    <p class="text-xs text-gray-500">${formatDate(comment.date)}</p>
                                </div>
                                <p class="text-sm mt-1">${comment.text}</p>
                            </div>
                        `).join('') 
                        : 
                        '<p class="text-sm text-gray-500 italic">No comments yet</p>'
                    }
                </div>
            </div>
            
            ${currentRole !== 'user' || request.status === 'resolved' ? `
            <div>
                <h4 class="text-sm font-medium text-gray-500">Add Comment</h4>
                <textarea id="commentText" rows="2" class="mt-1 w-full p-2 border rounded-md"></textarea>
                <button onclick="addComment('${id}')" class="mt-2 bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-1 rounded text-sm">
                    Add Comment
                </button>
            </div>
            ` : ''}
        </div>
    `;
    
    // Show or hide action button based on role/status
    const actionBtn = document.getElementById('modalAction');
    
    if (currentRole === 'hod' && request.status === 'pending_approval') {
        actionBtn.textContent = 'Approve';
        actionBtn.style.display = 'block';
        actionBtn.onclick = () => approveRequest(id);
    } else if (currentRole === 'it_head' && (request.status === 'pending' || request.status === 'approved')) {
        actionBtn.textContent = 'Assign';
        actionBtn.style.display = 'block';
        actionBtn.onclick = () => assignRequest(id);
    } else if (currentRole === 'technician' && request.status === 'assigned') {
        actionBtn.textContent = 'Resolve';
        actionBtn.style.display = 'block';
        actionBtn.onclick = () => resolveRequest(id);
    } else {
        actionBtn.style.display = 'none';
    }
    
    document.getElementById('modal').classList.remove('hidden');
}

// Add comment to request
async function addComment(id) {
    const commentText = document.getElementById('commentText').value.trim();
    if (!commentText) {
        showNotification('Please enter a comment', 'error');
        return;
    }
    
    try {
        const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer 9qVU9vgW1AdSZJL4WNZ2fzKtFC72',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                appSlug,
                action: 'update',
                collection: 'requests',
                conditions: { _id: id },
                data: {
                    $push: { 
                        comments: { 
                            text: commentText, 
                            user: document.getElementById('userName').textContent,
                            role: currentRole,
                            date: new Date().toISOString() 
                        } 
                    }
                }
            })
        });
        
        const data = await response.json();
        if (data.success) {
            showNotification('Comment added successfully');
            await loadRequests();
            viewRequest(id);
            
            // Add audit log
            await addAuditLog({
                user: document.getElementById('userName').textContent,
                action: 'Added Comment',
                details: `Comment on request ${id.slice(-6)}`
            });
            
            // Notify the requester
            const request = requests.find(r => r._id === id);
            if (request && currentRole !== 'user') {
                await addNotification({
                    role: 'user',
                    title: 'New Comment',
                    message: `${document.getElementById('userName').textContent} commented on your request`,
                    requestId: id,
                    date: new Date().toISOString()
                });
            }
        }
    } catch (error) {
        console.error('Error adding comment:', error);
        showNotification('Error adding comment', 'error');
    }
}

// Approve request
function approveRequest(id) {
    document.getElementById('modalTitle').textContent = 'Approve Request';
    document.getElementById('modalContent').innerHTML = `
        <p class="mb-4">Are you sure you want to approve this service request?</p>
        <textarea id="approveComment" class="w-full p-2 border rounded" placeholder="Add comment (optional)"></textarea>
    `;
    document.getElementById('modalFooter').classList.remove('hidden');
    document.getElementById('modalAction').textContent = 'Approve';
    document.getElementById('modalAction').style.display = 'block';
    document.getElementById('modalAction').onclick = async () => {
        const comment = document.getElementById('approveComment').value;
        await updateRequestStatus(id, 'approved', comment || 'Request approved');
        closeModal();
    };
    document.getElementById('modal').classList.remove('hidden');
}

// Reject request
function rejectRequest(id) {
    document.getElementById('modalTitle').textContent = 'Reject Request';
    document.getElementById('modalContent').innerHTML = `
        <p class="mb-4">Please provide a reason for rejection:</p>
        <textarea id="rejectComment" class="w-full p-2 border rounded" placeholder="Reason for rejection"></textarea>
    `;
    document.getElementById('modalFooter').classList.remove('hidden');
    document.getElementById('modalAction').textContent = 'Reject';
    document.getElementById('modalAction').style.display = 'block';
    document.getElementById('modalAction').onclick = async () => {
        const comment = document.getElementById('rejectComment').value;
        if (!comment) {
            showNotification('Please provide a reason for rejection', 'error');
            return;
        }
        await updateRequestStatus(id, 'rejected', comment);
        closeModal();
    };
    document.getElementById('modal').classList.remove('hidden');
}

// Assign request to technician
function assignRequest(id) {
    document.getElementById('modalTitle').textContent = 'Assign Request';
    document.getElementById('modalContent').innerHTML = `
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Select Technician</label>
            <select id="technician" class="w-full p-2 border rounded">
                ${technicians.map(tech => `
                    <option value="${tech.id}">${tech.name} (${tech.specialization})</option>
                `).join('')}
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Instructions</label>
            <textarea id="assignComment" class="w-full p-2 border rounded" placeholder="Instructions for technician (optional)"></textarea>
        </div>
    `;
    document.getElementById('modalFooter').classList.remove('hidden');
    document.getElementById('modalAction').textContent = 'Assign';
    document.getElementById('modalAction').style.display = 'block';
    document.getElementById('modalAction').onclick = async () => {
        const technician = document.getElementById('technician').value;
        const comment = document.getElementById('assignComment').value;
        const techName = getTechnicianName(technician);
        await updateRequestStatus(
            id, 
            'assigned', 
            comment ? `Assigned to ${techName}: ${comment}` : `Assigned to ${techName}`, 
            technician
        );
        closeModal();
    };
    document.getElementById('modal').classList.remove('hidden');
}

// Resolve request
function resolveRequest(id) {
    document.getElementById('modalTitle').textContent = 'Resolve Request';
    document.getElementById('modalContent').innerHTML = `
        <p class="mb-4">Please provide resolution details:</p>
        <textarea id="resolveComment" class="w-full p-2 border rounded" placeholder="Resolution details"></textarea>
    `;
    document.getElementById('modalFooter').classList.remove('hidden');
    document.getElementById('modalAction').textContent = 'Resolve';
    document.getElementById('modalAction').style.display = 'block';
    document.getElementById('modalAction').onclick = async () => {
        const comment = document.getElementById('resolveComment').value;
        if (!comment) {
            showNotification('Please provide resolution details', 'error');
            return;
        }
        await updateRequestStatus(id, 'resolved', comment);
        closeModal();
    };
    document.getElementById('modal').classList.remove('hidden');
}

// Add feedback for resolved request
function addFeedback(id) {
    document.getElementById('modalTitle').textContent = 'Add Feedback';
    document.getElementById('modalContent').innerHTML = `
        <p class="mb-4">How would you rate the resolution of your request?</p>
        <div class="flex items-center gap-2 mb-4">
            <div class="flex text-yellow-400 text-2xl">
                <i class="bi bi-star" data-rating="1"></i>
                <i class="bi bi-star" data-rating="2"></i>
                <i class="bi bi-star" data-rating="3"></i>
                <i class="bi bi-star" data-rating="4"></i>
                <i class="bi bi-star" data-rating="5"></i>
            </div>
            <span id="ratingText" class="text-sm text-gray-500">Select rating</span>
        </div>
        <textarea id="feedbackComment" class="w-full p-2 border rounded" placeholder="Additional feedback (optional)"></textarea>
    `;
    
    // Set up star rating
    const stars = document.querySelectorAll('[data-rating]');
    let currentRating = 0;
    
    stars.forEach(star => {
        star.addEventListener('mouseover', () => {
            const rating = parseInt(star.getAttribute('data-rating'));
            highlightStars(rating);
        });
        
        star.addEventListener('mouseout', () => {
            highlightStars(currentRating);
        });
        
        star.addEventListener('click', () => {
            currentRating = parseInt(star.getAttribute('data-rating'));
            highlightStars(currentRating);
            document.getElementById('ratingText').textContent = `${currentRating} stars`;
        });
    });
    
    function highlightStars(count) {
        stars.forEach(star => {
            const rating = parseInt(star.getAttribute('data-rating'));
            if (rating <= count) {
                star.classList.remove('bi-star');
                star.classList.add('bi-star-fill');
            } else {
                star.classList.remove('bi-star-fill');
                star.classList.add('bi-star');
            }
        });
    }
    
    document.getElementById('modalFooter').classList.remove('hidden');
    document.getElementById('modalAction').textContent = 'Submit Feedback';
    document.getElementById('modalAction').style.display = 'block';
    document.getElementById('modalAction').onclick = async () => {
        if (currentRating === 0) {
            showNotification('Please select a rating', 'error');
            return;
        }
        
        const feedback = document.getElementById('feedbackComment').value;
        const comment = `Rating: ${currentRating}/5 stars${feedback ? ' - ' + feedback : ''}`;
        
        try {
            const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer 9qVU9vgW1AdSZJL4WNZ2fzKtFC72',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    appSlug,
                    action: 'update',
                    collection: 'requests',
                    conditions: { _id: id },
                    data: {
                        rating: currentRating,
                        $push: { 
                            comments: { 
                                text: comment, 
                                user: document.getElementById('userName').textContent,
                                role: currentRole,
                                date: new Date().toISOString() 
                            } 
                        }
                    }
                })
            });
            
            const data = await response.json();
            if (data.success) {
                showNotification('Feedback submitted successfully');
                await loadRequests();
                closeModal();
                
                // Add audit log
                await addAuditLog({
                    user: document.getElementById('userName').textContent,
                    action: 'Submitted Feedback',
                    details: `Rating: ${currentRating}/5 for request ${id.slice(-6)}`
                });
            }
        } catch (error) {
            console.error('Error submitting feedback:', error);
            showNotification('Error submitting feedback', 'error');
        }
    };
    document.getElementById('modal').classList.remove('hidden');
}

// Show audit logs
function showAuditLogs() {
    renderAuditLogs();
    document.getElementById('auditLogModal').classList.remove('hidden');
}

// Close audit log modal
function closeAuditLogModal() {
    document.getElementById('auditLogModal').classList.add('hidden');
}

// Update dashboard metrics
function updateDashboard() {
    // Calculate metrics
    const totalCount = requests.length;
    const pendingCount = requests.filter(r => r.status === 'pending' || r.status === 'pending_approval').length;
    const resolvedCount = requests.filter(r => r.status === 'resolved').length;
    
    // Calculate average resolution time
    let avgTime = 0;
    let resolvedRequests = requests.filter(r => r.status === 'resolved');
    if (resolvedRequests.length > 0) {
        let totalHours = 0;
        for (const req of resolvedRequests) {
            const created = new Date(req.date);
            // Find the resolved comment to get resolution time
            const resolvedComment = req.comments?.find(c => c.text.includes('resolved'));
            if (resolvedComment) {
                const resolved = new Date(resolvedComment.date);
                totalHours += (resolved - created) / (1000 * 60 * 60); // Convert ms to hours
            }
        }
        avgTime = Math.round(totalHours / resolvedRequests.length);
    }
    
    // Update dashboard UI
    document.getElementById('totalRequests').textContent = totalCount;
    document.getElementById('pendingRequests').textContent = pendingCount;
    document.getElementById('resolvedRequests').textContent = resolvedCount;
    document.getElementById('avgResolutionTime').textContent = `${avgTime}h`;
    
    // Fake stats for visual appeal
    document.getElementById('totalRequestsChange').textContent = getRandomChange();
    document.getElementById('pendingRequestsChange').textContent = getRandomChange();
    document.getElementById('resolvedRequestsChange').textContent = getRandomChange();
    document.getElementById('avgResolutionTimeChange').textContent = getRandomChange();
}

// Update chart visualizations
function updateCharts() {
    // Request Types Chart
    const incidentCount = requests.filter(r => r.requestType === 'incident').length;
    const serviceCount = requests.filter(r => r.requestType === 'service').length;
    const maxTypeCount = Math.max(incidentCount, serviceCount, 1); // Avoid division by zero
    
    document.getElementById('incidentBar').style.height = `${(incidentCount / maxTypeCount) * 150}px`;
    document.getElementById('serviceBar').style.height = `${(serviceCount / maxTypeCount) * 150}px`;
    
    // Categories Chart
    const appCount = requests.filter(r => r.category === 'application').length;
    const hwCount = requests.filter(r => r.category === 'hardware').length;
    const maxCatCount = Math.max(appCount, hwCount, 1); // Avoid division by zero
    
    document.getElementById('applicationBar').style.height = `${(appCount / maxCatCount) * 150}px`;
    document.getElementById('hardwareBar').style.height = `${(hwCount / maxCatCount) * 150}px`;
}

// Change user role (for demo purposes)
function changeRole() {
    const roles = ['user', 'hod', 'it_head', 'technician'];
    const currentIndex = roles.indexOf(currentRole);
    currentRole = roles[(currentIndex + 1) % roles.length];
    
    // Update UI to reflect new role
    document.getElementById('userRole').textContent = `Role: ${formatRole(currentRole)}`;
    
    // Reset view to match role
    changeView(currentRole);
    
    // Refresh notifications for the new role
    initializeNotifications();
    
    showNotification(`Changed role to ${formatRole(currentRole)}`);
}

// Change dashboard view
function changeView(view) {
    currentView = view;
    
    // Reset all view buttons
    document.querySelectorAll('#userViewBtn, #hodViewBtn, #itHeadViewBtn, #technicianViewBtn').forEach(btn => {
        btn.classList.remove('bg-blue-50', 'border-blue-200');
        btn.classList.add('bg-white', 'border-gray-200');
        btn.querySelector('i').classList.remove('text-blue-600');
        btn.querySelector('i').classList.add('text-gray-600');
    });
    
    // Highlight selected view
    document.getElementById(`${view}ViewBtn`).classList.remove('bg-white', 'border-gray-200');
    document.getElementById(`${view}ViewBtn`).classList.add('bg-blue-50', 'border-blue-200');
    document.getElementById(`${view}ViewBtn`).querySelector('i').classList.remove('text-gray-600');
    document.getElementById(`${view}ViewBtn`).querySelector('i').classList.add('text-blue-600');
    
    // Hide all role-specific views first
    document.getElementById('hodApprovalQueue').classList.add('hidden');
    document.getElementById('itHeadQueue').classList.add('hidden');
    document.getElementById('technicianTasks').classList.add('hidden');
    
    // Show role-specific view if selected
    if (view === 'hod') {
        document.getElementById('hodApprovalQueue').classList.remove('hidden');
        renderHodQueue();
    } else if (view === 'it_head') {
        document.getElementById('itHeadQueue').classList.remove('hidden');
        renderItHeadQueue();
    } else if (view === 'technician') {
        document.getElementById('technicianTasks').classList.remove('hidden');
        renderTechnicianTasks();
    }
    
    // Update the request table based on the view
    filterRequests();
}

// Show notification
function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.classList.add('show');
    notification.style.backgroundColor = type === 'success' ? '#10B981' : '#EF4444';
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// Clear filters
function clearFilters() {
    document.getElementById('typeFilter').value = 'all';
    document.getElementById('categoryFilter').value = 'all';
    document.getElementById('statusFilter').value = 'all';
    document.getElementById('dateFilter').value = '';
    filterRequests();
}

// Filter requests
function filterRequests() {
    renderRequests();
}

// Close modal
function closeModal() {
    document.getElementById('modal').classList.add('hidden');
}

// Helper function to get technician name by ID
function getTechnicianName(techId) {
    const technician = technicians.find(t => t.id === techId);
    return technician ? technician.name : techId;
}

// Format date
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Format time ago
function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    
    const diffSecs = Math.floor(diffMs / 1000);
    if (diffSecs < 60) return `${diffSecs}s ago`;
    
    const diffMins = Math.floor(diffSecs / 60);
    if (diffMins < 60) return `${diffMins}m ago`;
    
    const diffHours = Math.floor(diffMins / 60);
    if (diffHours < 24) return `${diffHours}h ago`;
    
    const diffDays = Math.floor(diffHours / 24);
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString();
}

// Format status
function formatStatus(status) {
    switch(status) {
        case 'pending_approval': return 'Pending Approval';
        case 'pending': return 'Pending';
        case 'approved': return 'Approved';
        case 'assigned': return 'Assigned';
        case 'resolved': return 'Resolved';
        case 'rejected': return 'Rejected';
        default: return status;
    }
}

// Format role
function formatRole(role) {
    switch(role) {
        case 'hod': return 'HOD';
        case 'it_head': return 'IT Head';
        case 'technician': return 'Technician';
        case 'user': return 'User';
        default: return role;
    }
}

// Get status color
function getStatusColor(status) {
    switch(status) {
        case 'pending_approval': return 'bg-orange-100 text-orange-800';
        case 'pending': return 'bg-yellow-100 text-yellow-800';
        case 'approved': return 'bg-green-100 text-green-800';
        case 'assigned': return 'bg-blue-100 text-blue-800';
        case 'resolved': return 'bg-purple-100 text-purple-800';
        case 'rejected': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

// Get priority color
function getPriorityColor(priority) {
    switch(priority) {
        case 'low': return 'bg-gray-100 text-gray-800';
        case 'medium': return 'bg-blue-100 text-blue-800';
        case 'high': return 'bg-orange-100 text-orange-800';
        case 'critical': return 'bg-red-100 text-red-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

// Generate random change percentage for demo
function getRandomChange() {
    const sign = Math.random() > 0.5 ? '+' : '-';
    const value = Math.floor(Math.random() * 15);
    return `${sign}${value}%`;
}

// Initialize the application when DOM is loaded
document.addEventListener('DOMContentLoaded', initializeApp);
</script>
<script>document.body.addEventListener('wheel', e => { if (!e.ctrlKey) return; e.preventDefault(); return }, { passive: false })</script>
	</body>
</html>